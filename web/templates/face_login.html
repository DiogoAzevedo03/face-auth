<!-- ============================================
 Face Recognition Login Page - FaceAuth Web Interface
 File: face_login.html
 Authors: Diogo Azevedo and LetÃ­cia Loureiro
 Date: 2025-04-23

 Description:
 This HTML page provides a camera-based face login interface.
 Users are automatically authenticated through their face,
 and redirected based on their role (admin/user).
 
 Includes fallback to manual login if recognition fails.
 ============================================ -->

 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <title>Face Recognition Login</title>
 
     <!-- Load external CSS file -->
     <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
 
     <!-- Page-specific styling for video and alignment -->
     <style>
        video, canvas {
            border-radius: 10px;      /* Rounded edges for media */
            margin-top: 10px;         /* Spacing below title */
        }
        .centered {
            text-align: center;       /* Center content horizontally */
        }
    </style>
 </head>
 <body class="centered">
    <!-- Page heading -->
    <h1>Face Recognition Login</h1>

    <!-- Live video stream from the user's camera -->
    <video id="video" width="320" height="240" autoplay></video>

    <!-- Hidden canvas for capturing an image frame from the video -->
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

    <!-- Text for displaying current camera/login status -->
    <p id="status">Initializing camera...</p>
 
     <!-- Retry Recognition Button (hidden by default) -->
     <button id="retryBtn" onclick="retryRecognition()" style="display:none;">Try Again</button>
 
     <!-- Fallback button for manual login -->
     <button onclick="loginManual()">Manual Login</button>
 
     <script>
                 // Reference to DOM elements
         const video = document.getElementById('video');
         const canvas = document.getElementById('canvas');
         const statusText = document.getElementById('status');
         const retryBtn = document.getElementById('retryBtn');
         const manualLoginUrl = "{{ url_for('auth.manual_login') }}";


// Request access to the webcam and stream it into the <video> element
    navigator.mediaDevices.getUserMedia({ video: true })
             .then(stream => {
                 // Assign stream to video element
                 video.srcObject = stream;
 
                 // Update status message
                 statusText.textContent = "Capturing image...";
 
                 // Wait 3 seconds and then take a snapshot
                 setTimeout(captureAndSend, 3000);
             })
             .catch(err => {
                 // Handle camera access failure
                 statusText.textContent = "Error accessing camera.";
                 console.error(err);
             });
 
          // Capture a frame from the video, convert to image, and send to server
         function captureAndSend() {
             const ctx = canvas.getContext('2d');
 
             // Draw the current video frame to the hidden canvas
             ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
 
             // Convert the canvas content to a Base64 image string
             const imageData = canvas.toDataURL('image/jpeg');
 
             // Update status
             statusText.textContent = "Processing image...";
 
            // Send image to server via POST
             fetch("/face-login", {
                 method: "POST",
                 headers: { 
                    "Content-Type": "application/json" 
                 },
                 body: JSON.stringify({ image: imageData })
             })
             .then(res => res.json())
             .then(data => {
                // Debugging info in console
                 console.log("Server response:", data);
 
                // Check if user was recognized successfully
                 if (data.success) {
                     statusText.textContent = `Welcome, ${data.user}`;
                     retryBtn.style.display = "none";

                    // Redirect after a short delay
                     setTimeout(() => {
                         window.location.href = data.redirect;
                     }, 1500);
                 } else {
                    // If not recognized
                     statusText.textContent = "User not recognized.";
                     retryBtn.style.display = "inline-block";
                 }
             });
         }
 
         // Retry logic
         function retryRecognition() {
             statusText.textContent = "Retrying... Capturing new image.";
             retryBtn.style.display = "none";
             setTimeout(captureAndSend, 1000);
         }
 
         function loginManual() {
            window.location.href = manualLoginUrl;
        }
     </script>
 </body>
 </html>
 
